name: Release
run-name: "Release (branch: ${{ github.ref_name }}; version: ${{ inputs.version }})"

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true

permissions:
  contents: write  # To be able to publish the release
  pull-requests: write

jobs:

  release:
    runs-on: ubuntu-24.04
    permissions:                # Job-level permissions configuration starts here
      contents: write           # 'write' access to repository contents
      pull-requests: write
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup GnuPG
        env:
          SIGNING_GPG_KEY: ${{ secrets.SIGNING_GPG_KEY }}
          SIGNING_PASSPHRASE: ${{ secrets.SIGNING_PASSPHRASE }}
        run: |
          export GPG_TTY=$(tty)
          sudo install -d -m 0700 -o "$(id -u)" -g "$(id -g)" /run/gpg
          export GNUPGHOME="$(mktemp -d -p /run/gpg)"
          echo "GNUPGHOME=${GNUPGHOME}" >> "$GITHUB_ENV"
          cat <<EOF > "${GNUPGHOME}/gpg.conf"
          batch
          no-tty
          pinentry-mode loopback
          passphrase-file ${GNUPGHOME}/passphrase
          EOF
          echo "${SIGNING_PASSPHRASE}" > "${GNUPGHOME}/passphrase"
          echo "${SIGNING_GPG_KEY}" | gpg --import -
          sync


      - run: |
          git config --global --add safe.directory "$(pwd)"
          git config --global user.name "Salt Project Packaging"
          git config --global user.email saltproject-packaging@vmware.com
          git config --global user.signingkey 64CBBC8173D76B3F
          git config --global commit.gpgsign true
          git config --global gpg.program $(which gpg) -v

      - run: |
          export GPG_TTY=$(tty)
          cat "${GNUPGHOME}/gpg.conf"
          echo 123 > meh
          git add meh
          git commit -m meh
          #git tag -m "Release ${{ inputs.version }}" -as v${{ inputs.version }}

      - name: Push Changes
        uses: ad-m/github-push-action@b87afee92c6e70ea888be6203a3e9426fda49839
        with:
          ssh: true
          tags: true
          atomic: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Get release
        id: get_release
        uses: agners/get-draft-release@v1.2.2
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - uses: eregon/publish-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_id: ${{ steps.get_release.outputs.id }}
